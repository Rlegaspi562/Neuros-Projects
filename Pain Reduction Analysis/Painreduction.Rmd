---
title: "Pain Reduction Analysis"
author: "Rumil Legaspi"
date: "8/26/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```




# Pain Reduction Analysis Project

## Introduction
  
Pain reduction - the primary efficacy endpoint of the QUEST Study. Understanding the level of pain reduced holds utmost importance, not only for the clinical team at NEUROS, but more importantly for the under-served post-amputee population seeking treatment. In nearing the end of the study, we have seen an increase in the passing of subjects within the eligibility phase, specifically, during the saline and lidocaine injections. This short analysis aims to explore the Saline and Lidocaine injections of subjects within the years of 2019 to the month of August 2021, using data extracts derived from the EDC system, Clindex.

# Objectives and Questions
The following are a few questions this analysis seeks to better understand:

- On average, what is the percent in pain reduction subjects are receiving post-saline and lidocaine injection? By Site?

- What do the drops in pain look like? Specifically, how do sites compare and look like.

- Based on the passing were seeing how are they passing and if failing how are they failing?

- Filter by year through 2019-2021.


- What are the pass rates in 2019-2021 by year (the cut from 23rd aug extract).

- how many passed saline, how many passed lidocaines, for all of them.
- based on subjects that passed how much on averae did they pass by?
-Who failed and passed? by year, and in total (all years 2019-2021 combined)

- then only subjects who passed, I take 0 minute saline mark in those 3 years and that 0 min    column minus 20 minutes to
    - see what verage pain decraease is, percentage wise
    - max min, medium,, basic stats
    - highest performing and least performing sites



## In short...
- sort who passed?
- Analyze pain decrease
- How much are subjects passing by? intl - abs(sal_20min/lido_20min)
- what does the data distribution look like?
- How does it look relative to previous years?
- Any more clues on the increase of injection rates?
- Which sites are often failing/passing?
- See if there is anything interesting that can be found from target location of injection

#  Loading in Libraries
```{r, echo = FALSE, results = "hide", include = FALSE}
library(tidyverse)
library(lubridate)
library(readr)
library(cowplot)
library(plotly)
library(hrbrthemes)

```

# Filepaths
```{r}
#pc <-
```


# 1. Importing Data
```{r, results = "hide", include = FALSE}
# Evaluation Visit
eval_visit <- read_csv("Data/nm_evalvis (5).csv", locale = locale(encoding = "Latin1"))
#View(nm_evalvis_5_)

# Saline Injections
saline_inj <- read_csv("Data/nm_saline.csv")
#View(saline_inj)

# Lidocaine Injections
lidocaine_inj <- read_csv("Data/nm_lidocain.csv")
#View(lidocaine_inj)
```



# Joining Datasets
```{r}
# 1. left Joining saline and Lidocaine datasets first

glimpse(saline_inj)

glimpse(lidocaine_inj)

sal_lido_join <- left_join(saline_inj, lidocaine_inj, by = "KEYID")

# 2. left joining saline and lido dataset with evaluation visit dataset

inj_data <- left_join(sal_lido_join, eval_visit, by = "KEYID") 

```



# 2. Data Cleaning
```{r}
# Selecting & renaming Columns
cleaning_inj_data <- inj_data %>% 
  rename(key_id              = KEYID,
         site                = `Site #`,
         subj_id             = `SUB_KEYID.x`,
         visit_date          = `Date of visit`,
         sal_00min            = `0 min.x`,
         sal_05min            = `+ 5 min.x`,
         sal_10min           = `+ 10 min.x`,
         sal_15min           = `+ 15 min.x`,
         sal_20min           = `+ 20 min.x`,
         lido_00min           = `0 min.y`,
         lido_05min           = `+ 5 min.y`,
         lido_10min          = `+ 10 min.y`,
         lido_15min          = `+ 15 min.y`,
         lido_20min          = `+ 20 min.y`,
         inj_eval_num        = `Injection Evlaution Form Number`,
         meds_today          = `N/A, None today`,
         med_name            = Name,
         med_dose            = Dose,
         med_time            = Time,
         time_intl_pain_lvl  = `Time of Pain rating`,
         intl_pain_lvl       = `What is subject<U+0092>s Overall limb pain right now?`,
         sal_inj_not_done    = `Saline Injection Not Done` ,
         inj_location        = `Target of injection`,
         sal_inj_start_time  = `Time of saline injection`,
         sal_inj_end_time    = `End of Saline Assessment Time`,
         sal_eval_outcome    = `Saline Injection Outcome?`,
         lido_inj_start_time = `Time of lidocaine injection`,
         lido_inj_end_time   = `End of Lidocaine Assessment Time`,
         lido_eval_outcome   = `Lidocaine Injection Outcome` 
         
         )
```

# More Data Cleaning
```{r}
#Changing Data Types

visit_date1 <- lubridate::mdy(cleaning_inj_data$visit_date) #converting visit_date into date type
cleaning_inj_data <- cleaning_inj_data %>%  mutate(visit_dates = visit_date1) %>% 
  glimpse()

#Appending vector to data frame
  
  #  test <- "12/9/2014"
  # lubridate::mdy(test)
  # #[1] "2014-12-09"
```


Dropping and Rearranging Columns

```{r}

# Checking Column Indexes
colnames(cleaning_inj_data)

#Dropping by col index
cleaning_inj_data <- cleaning_inj_data[-c(2, 3, 4, 10, 11, 12, 28, 29, 33, 34, 39, 40, 43, 44)] %>% rename(subj_id = `Unique Subject ID`,
                lidocaine_injection_not_done = `Lidocaine Injection Not Done`,
                injection_evaluation_outcome = `Injection Evaluation Outcome`
                ) 

#Rearranging Columns and changing into cleaned_data
cleaning_inj_data <- cleaning_inj_data %>% 
  relocate(site, subj_id, visit_dates, .after = key_id)
```





Remove Extra Characters in Data
```{r}
#as_tibble(cleaned_data)

#Cleaning inj_location
cleaning_inj_data$inj_location <- str_replace_all(cleaning_inj_data$inj_location, 
              "[:digit:]|[:punct:]", 
              "") %>% 
              str_trim()

#cleaning injection_eval_outcome (cleaning in a different way using gsub)
  #the pattern here is the first 9 characters (thereby taking care of spaces)
cleaning_inj_data$injection_evaluation_outcome <- gsub(pattern = "^.{0,9}",
                                                       replacement = "", 
                                                       x = cleaning_inj_data$injection_evaluation_outcome)



#Cleaning lido_eval_outcome
cleaning_inj_data$lido_eval_outcome <- gsub(pattern = "^.{0,9}",
                                            replacement = "", 
                                            x = cleaning_inj_data$lido_eval_outcome)


#Cleaning sal_eval_outcome
cleaning_inj_data$sal_eval_outcome <- gsub(pattern = "^.{0,9}",
                                            replacement = "", 
                                            x = cleaning_inj_data$sal_eval_outcome )

#cleaning intl_pain_lvl
cleaning_inj_data$intl_pain_lvl <- gsub(pattern = "^.{0,9}",
                                            replacement = "", 
                                            x = cleaning_inj_data$intl_pain_lvl)

#Cleaning Sal_inj_not_done (yes/no)
cleaning_inj_data$sal_inj_not_done <- gsub(pattern = "^.{0,4}",
                                            replacement = "", 
                                            x = cleaning_inj_data$sal_inj_not_done)
#Cleaning meds_today (yes/no)
cleaning_inj_data$meds_today <- gsub(pattern = "^.{0,4}",
                                            replacement = "", 
                                            x = cleaning_inj_data$meds_today)
#Cleaning lido_inj_not_done 
cleaning_inj_data$lidocaine_injection_not_done <- gsub(pattern = "^.{0,4}",
                                            replacement = "", 
                                            x = cleaning_inj_data$lidocaine_injection_not_done)

#appending
cleaning_inj_data <- cleaning_inj_data %>% 
  mutate(inj_location = cleaning_inj_data$inj_location,
         injection_evaluation_outcome = cleaning_inj_data$injection_evaluation_outcome,
         lido_eval_outcome = cleaning_inj_data$lido_eval_outcome,
         sal_eval_outcome = cleaning_inj_data$sal_eval_outcome,
         intl_pain_lvl = cleaning_inj_data$intl_pain_lvl,
         sal_inj_not_done = cleaning_inj_data$sal_inj_not_done,
         meds_today = cleaning_inj_data$meds_today,
         lidocaine_injection_not_done = cleaning_inj_data$lidocaine_injection_not_done)


```


Changing Data Types
```{r}
#Turning variables into factors with 2 or more levels.

#inj_location
cleaning_inj_data$inj_location <- as.factor(cleaning_inj_data$inj_location) 

#inj_eval_outcome
cleaning_inj_data$injection_evaluation_outcome <- as.factor(cleaning_inj_data$injection_evaluation_outcome) 

#sal_eval_outcome
cleaning_inj_data$sal_eval_outcome <- as.factor(cleaning_inj_data$sal_eval_outcome) 

#sal_inj_not_done
cleaning_inj_data$sal_inj_not_done <- as.factor(cleaning_inj_data$sal_inj_not_done) 

#lido_eval_outcome
cleaning_inj_data$lido_eval_outcome <- as.factor(cleaning_inj_data$lido_eval_outcome) 

#lidoocaine_injection_not_done
cleaning_inj_data$lidocaine_injection_not_done <- as.factor(cleaning_inj_data$lidocaine_injection_not_done) 

#Changing intl_pain level from Chr to numeric
cleaning_inj_data$intl_pain_lvl <- as.double(cleaning_inj_data$intl_pain_lvl)

#Changing into cleaned_data
cleaning_inj_data <- cleaning_inj_data %>% 
  mutate(inj_location = cleaning_inj_data$inj_location)


```

checking data 
```{r}
glimpse(cleaning_inj_data)
colnames(cleaning_inj_data)
```

#cleaning to cleaned
```{r}
cleaned_data <- cleaning_inj_data
```


Filtering by years. Two different datasets 2014-21 & 2019-21
```{r}
#Filtering by year (2019-2021)
 cleaned_data_19_21 <- cleaned_data %>% 
   filter(visit_dates >= '2019-01-01') %>% 
   glimpse()

 #Filtering by year (2014-2021)
 cleaned_data_14_21 <- cleaned_data %>% 
   filter(visit_dates >= '2014-01-01') %>% 
   glimpse()

```


# Starting Analyses


## A Distribution of our Variables
Note: eval outcome should be a factor

```{r}

Inj_data_plots_14_21 <- cleaned_data_14_21[-c(1:3, 15,22)] %>%
  keep(is.numeric) %>%                       # Using numeric columns
  gather() %>%  
  ggplot(aes(value)) +                       #plotting
    facet_wrap(~ key, scales = "free", ncol = 5) +
    geom_bar()                     #try geom_density/histo
 

#2014-2021
Inj_data_plots_14_21


Inj_data_plots_19_21 <- cleaned_data_14_21[-c(1:3, 15,22)] %>%
    keep(is.numeric) %>%                       # Using numeric columns
  gather() %>%  
  ggplot(aes(value)) +                       #plotting
    facet_wrap(~ key, scales = "free",nrow = 2, ncol = 5) +
    geom_bar()  +
  scale_fill_brewer(palette = "Set2")
  
  
# 
#   select(sal_0min, sal_5min, sal_10min, sal_15min, sal_20min,
#          lido_0min, lido_5min, lido_10min, lido_15min, lido_20min) %>%                                
#   ggplot(aes(value)) +  
#   geom_bar() +
#   facet_wrap(~count, nrow = 2, ncol = 5) +
#   scale_fill_brewer(palette = "Set2")

#2019-2021
Inj_data_plots_19_21
```

#F8766D
#00BFC4
```{r}
   scale_color_manual(fill = c(lido_0min = "#00BFC4", lido_5in = "#00BFC4", lido_10min = "#00BFC4", lido_15min = "#00BFC4", lido_20min = "#00BFC4", sal_0min = "#F8766D", sal_5in = "#F8766D", sal_10min = "#F8766D", sal_15min = "#F8766D", sal_20min = "#F8766D"))
```





## In short...
- sort who passed?
```{r}
#Creating on pass column
test_inj_eval_outcome <- cleaning_inj_data %>% 
  select(injection_evaluation_outcome) %>% 
  mutate(pass = ifelse(injection_evaluation_outcome == "Pass (pain reduction >= 50%)",
                       yes = 1,
                       no = ifelse(injection_evaluation_outcome == "Pass (both saline and lidocaine assessments)",
                                   yes = 1,
                                   no = 0)))
         
test_inj_eval_outcome
```


```{r}
count_subjects_passed <- cleaned_data %>% 
  count(injection_evaluation_outcome) %>% 
  
  # Piping our previous output into a barchart to visualize
ggplot(aes(x = injection_evaluation_outcome, y = n)) +
  geom_col(show.legend = FALSE) +
  xlab("Injection Evaluation") +
  ylab("Frequency") +
  ggtitle("Frequency of Type of Injection Evaluations") +
  geom_text(aes(label = n), position = position_dodge(width = 0.9), vjust = -0.25)

# Printing
count_subjects_passed
  
```


- Analyze pain decrease
- How much are subjects passing by? intl - abs(sal_20min/lido_20min)


```{r}
sal_change_in_pain <- abs(cleaned_data$intl_pain_lvl - cleaned_data$sal_20min)
 mean(sal_change_in_pain, na.rm = TRUE)

#box.plot(cleaned_data$sal_change_in_pain)

ggplot(cleaned_data, aes(sal_change_in_pain, fill = sal_eval_outcome)) +
  geom_boxplot() 


 
```




- what does the data distribution look like?
- How does it look relative to previous years?
- Any more clues on the increase of injection rates?
- Which sites are often failing/passing?
- See if there is anything interesting that can be found from target location of injection














Correlations
```{r}
# install.packages("corrr")
# install.packages("corrplot")
library(corrplot)
library(corrr)



Inj_data_corr <- cleaned_data %>%
  keep(is.numeric) %>%                       # Using numeric columns
   correlate() %>% fashion()

Inj_data_corr

num_inj_data <- cleaned_data %>%
  keep(is.numeric) %>% subset(select = -c(key_id))

cor(num_inj_data)



# matrix_num_inj_data <- as.matrix(as.data.frame(num_inj_data))
# # 
# corrplot(matrix_num_inj_data,  method = "number")
# # 
# corrplot(cor(num_inj_data))
# 
# pretty_data_corr <- ggcorrplot( hc.order = TRUE, type = "lower", lab = TRUE,
#                                outline.col = "white",
#                                ggtheme     = ggplot2::theme_gray,
#                                colors      = c("#6D9EC1", "white", "#E46726"))
# pretty_data_corr
# 
# 
table(num_inj_data$lido_eval_outcome, num_inj_data$inj_location)
ggplot(new_cleaned_inj_data, aes(x = inj_location, fill = lido_eval_outcome)) + geom_bar()

ggplot(new_cleaned_inj_data, aes(x = lido_eval_outcome, fill = inj_location)) + geom_bar()

#x indicating a count variable, and the fill as the category
#Next task is to go back and clean the observations with extra strings and NA's!
#also remove where target location is na and filter the date to captuer 2019-aug2021
# understand the NAs
```
```{r}
filter(new_cleaned_inj_data, visit_date >= "" )
```


```{r}

```

INCOMPLETE: Careful when running
```{r}
# Usual area chart
time_series_plot <- cleaned_data %>%
  ggplot( aes(x = visit_dates, y = lido_eval_outcome)) +
    geom_area(fill = "#69b3a2", alpha = 0.5) +
    geom_line(color = "#69b3a2") +
    ylab("Lidocaine Evaluation Outcomes") +
    theme_ipsum()

# Turn it interactive with ggplotly
time_series_plot <- ggplotly(time_series_plot)
time_series_plot
```



```{r}
# ANOVA! to tell if is significant difference in means of dependent variable given different levels of the categorical independent vars or combinations of levels of the independent variables

# new_cleaned_inj_data <- data.frame(new_cleaned_inj_data, stringsAsFactors = FALSE)
# 
# class(new_cleaned_inj_data$med_dose)
# ggplot(pretty_data_corr, aes(x, y)) + geom_point() + theme_bw()
# cor(pretty_data_corr)
# 
# 
# glimpse(new_cleaned_inj_data)
# 
# 
# new_cleaned_inj_data_fctrs <- new_cleaned_inj_data
# str(new_cleaned_inj_data_fctrs)
# 
# 
# new_cleaned_inj_data_fctrs ＜- as.factor(new_cleaned_inj_data_fctrs$subj_id)    
# class(new_cleaned_inj_data_fctrs$subj_id)
# 
# new_cleaned_inj_data_fctrs <- as.data.frame(unclass(new_cleaned_inj_data_fctrs))
# str(new_cleaned_inj_data_fctrs)
# cor(new_cleaned_inj_data_fctrs)

```














```{r}
# Inj_data_plots <- lapply(names(new_cleaned_inj_data), function(var_x){
#   p <-
#     ggplot(new_cleaned_inj_data) +
#     aes_string(var_x)
# 
#   if(is.numeric(new_cleaned_inj_data[[var_x]])) {
#     p <- p + geom_density()
# 
#   } else {
#     p <- p + geom_bar()
#   }
# 
# })
# 
# plot_grid(plotlist = Inj_data_plots)
```



So Who Passed?
```{r}
who_passed <- new_cleaned_inj_data %>% 
  select(lido_eval_outcome, subj_id, site)
  
#   filter()
#  filer(
#     lido_eval_outcome == str_detect(lido_eval_outcome, pattern = "Pass")
#   )
#  
# 
# ?str_detect
who_passed
  
```

  
<!--  - sort who passed -->
<!-- - analyze pain decrease -->
<!-- - are subjects blowing out water? decrease in pain 70,80,90%? -->
<!-- - what distribution looka like? -->
<!-- - How does it look relative to 2019-2020-2021 -->
<!-- - clues on our 3% increase in injection rates  -->



<!-- <<<<<<< HEAD -->
<!--   # Cleaning data types -->
<!-- cleaning_inj_data <- as.factor(cleaning_inj_data$sal_0min) -->
<!-- glimpse(cleaning_inj_data) -->


<!-- typeof(cleaning_inj_data$sal_0min) -->
<!-- #should i go integer or use double? -->
<!--  sal_5min, -->
<!--             sal_10min, -->
<!--             sal_15min, -->
<!--             sal_20min, -->
<!--             lido_0min, -->
<!--             lido_5min, -->
<!--             lido_10min, -->
<!--             lido_15min, -->
<!--             lido_20min, -->
<!--             intl_pain_lvl))   -->
<!-- ======= -->

<!-- >>>>>>> ac8c250d2d5b50cd54d7d11cdba6dafa5096b800 -->




<!--    as.Date(visit_date, "%d/%M/%Y")  -->



<!-- cleaned_inj_data %>% glimpse() -->

<!--   mutate(Date = as.Date(as.character(Date), "%d/%b/%Y")) -->




<!-- ?relocate -->

<!-- ``` -->




<!-- ```{r} -->
<!-- cleaned_inj_data %>% glimpse() -->
<!-- ``` -->


<!-- Patients Who Passed Injection from 2019 - Aug -->

<!-- ```{r} -->
<!-- cleaning_inj_data %>%  -->
<!--   relocate(site, ) -->


<!-- ``` -->




<!-- ``` -->

<!-- eval_visit <- eval_visit %>% rename(target_inj = `Target of injection`) -->


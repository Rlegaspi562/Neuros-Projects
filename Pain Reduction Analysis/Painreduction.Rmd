---
title: "Pain Reduction Analysis"
author: "Rumil Legaspi"
date: "8/26/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```



#Injection Analyses


## A Distribution of our Variables
Note: eval outcome should be a factor

```{r}

Inj_data_plots_14_21 <- cleaned_data_14_21[-c(1:3, 15,22,33:35)] %>%
  keep(is.numeric) %>%                       # Using numeric columns
  gather() %>%  
  ggplot(aes(value)) +                       #plotting
    facet_wrap(~ key, scales = "free", ncol = 5) +
    geom_bar(fill = "#F8766D")  + 
    labs(title="Injection Pain Distributions", 
         subtitle="JAN2014-AUG2021",
         caption="Source: Lidocaine & Saline Pain Levels 0 to 20 minutes",
         x="Reported Subject Pain Levels During Injections",
         y="Frequency")
                 

#2014-2021
Inj_data_plots_14_21


Inj_data_plots_19_21 <- cleaned_data_19_21[-c(1:3, 15,22,33:35)] %>%
    keep(is.numeric) %>%                       # Using numeric columns
  gather() %>%  
  ggplot(aes(value)) +                       #plotting
    facet_wrap(~ key, scales = "free",nrow = 2, ncol = 5) +
    geom_bar(fill = "#00BFC4")  + 
    labs(title="Injection Pain Distributions", 
         subtitle="JAN2019 - AUG2021 \nHistograms of Subject Reported Pain Levels",
         caption="Source: Lidocaine & Saline Pain Levels 0 to 20 minutes",
         x="Reported Subject Pain Levels During Injections",
         y="Frequency")

  


#2019-2021
Inj_data_plots_19_21
```

# flip lido and sal and 2019, 2020 & 2021
#pain level percentage before needle insertion


```{r}
install.packages("GGally")
library(GGally)
```





Proportion Of Injections Per Site
```{r}

g <- ggplot(cleaned_data, aes(reorder(site, inj_location, na.rm = TRUE)))
g + geom_bar(aes(fill=inj_location), width = 0.5) + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) + 
  labs(title="Histogram on Categorical Variable", 
       subtitle="Manufacturer across Vehicle Classes") +
   theme(legend.position = "bottom") + 
    labs(title="Injection Location by Site", 
         subtitle="Histogram of Injections By Injection Location",
         caption="Source: Injection Data",
         x="Site",
         y="Sum")


#Summary injection location
injection_location_summary <- cleaned_data %>% 
  select(inj_location, site) %>%  summary()


injection_location_summary
```
# See this by year 2019-21
(lower priority)


```{r}
count_subjects_passed <- cleaned_data %>% 
  count(injection_evaluation_outcome) %>% 
  
  # Piping our previous output into a barchart to visualize
ggplot(aes(x = injection_evaluation_outcome, y=n
           )) +
  geom_col(show.legend = FALSE, fill = "green4") +
  xlab("Injection Evaluation") +
  ylab("Frequency") +
  ggtitle("Injection Evaluations") +
  geom_text(aes(label = n), position = position_dodge(width = 0.9), vjust = -0.25) + coord_flip()

# Printing
count_subjects_passed
  
```



 How much are subjects passing by? 
 How much are subjects failing by?

  
  Analyzing Change in Pain
  
```{r}

injection_pain_change <- cleaning_inj_data %>% mutate(
  sal_change_in_pain = abs(cleaned_data$intl_pain_lvl - cleaned_data$sal_20min),
  lido_change_in_pain = abs(cleaned_data$intl_pain_lvl - cleaned_data$lido_20min))




saline_pass_boxplot <- injection_pain_change %>% select(
  sal_change_in_pain, pass)  %>%
  ggplot(aes(x = pass, y = sal_change_in_pain, fill = pass)) +
  geom_boxplot() +
  geom_jitter(width = 0.10, alpha = 0.5) + 
  labs(x = "Failed [0] : Passed [1]", y = "Change In Overall Pain Level") +
  theme(legend.position = "top") +
  coord_flip()  + 
    labs(title="Boxplot of Total Change in Pain Post Saline", 
         subtitle="",
         caption="Source: Lidocaine & Saline Pain Levels 0 to 20 minutes",
         x="Failed [0] : Passed [1]",
         y="Change in Pain")

saline_pass_boxplot


lidocaine_pass_boxplot <- injection_pain_change %>% select(
  lido_change_in_pain, pass)  %>%
  ggplot(aes(x = pass, y = lido_change_in_pain, fill = pass)) +
  geom_boxplot() +
  geom_jitter(width = 0.10, alpha = 0.5) + 
  labs(x = "Failed [0] : Passed [1]", y = "Change In Overall Pain Level") +
  theme(legend.position = "top") +
  coord_flip()  + 
    labs(title="Boxplot of Total Change in Pain Post Lidocaine", 
         caption="Source: Lidocaine & Saline Pain Levels 0 to 20 minutes",
         x="Failed [0] : Passed [1]",
         y="Change in Pain")

lidocaine_pass_boxplot
 
```
# plot percentage pain decrease relatve to pain saline needle insertion




Pain Levels of subject of subjects post injection

```{r}

ggplot(injection_pain_change) +
  aes(x = lido_change_in_pain, fill = pass) +
  geom_histogram(bins = 10, position = "dodge" ) +
  scale_fill_hue(direction = 1) +
  theme_minimal() +
  theme(legend.position = "top")  + 
    labs(title="Histogram of change in subjects pain levels post 20min Lidocaine Injection", 
         caption="Source: Lidocaine & Saline Pain Levels 0 to 20 minutes",
         x= "Count",
         y="Frequency")


ggplot(injection_pain_change) +
  aes(x = sal_change_in_pain, fill = pass) +
  geom_histogram(bins = 10, position = "dodge" ) +
  scale_fill_hue(direction = 1) +
  theme_minimal() +
  theme(legend.position = "top") + 
    labs(title="Histogram of change in subjects pain levels post 20min Saline Injection", 
         x="Count",
         y="Frequency")
```
# percentag pain decrease

## Of the people that passed where were they injected? And by what site?


```{r}
s <- ggplot(data = cleaned_data, aes(reorder(site, sal_change_in_pain, na.rm = TRUE), sal_change_in_pain))
s + geom_boxplot(varwidth=T, fill="plum") + 
    labs(title="Box plot", 
         subtitle="Change in Pain During Saline Injection Grouped by Site \nAscending in order of median",
         caption="Source: Initial Pain - 20 min Saline Pain",
         x="Site",
         y="Saline Change In Pain")


l <- ggplot(data = cleaned_data, aes(reorder(site, -lido_change_in_pain, na.rm = TRUE), lido_change_in_pain))
l + geom_boxplot(varwidth=T, fill="plum") + 
    labs(title="Box plot", 
         subtitle="Change in Pain During Lidocaine Injection Grouped by Site \nDescending in order of median",
         caption="Source: Initial Pain - 20 min Lidocaine Pain",
         x="Site",
         y="Lidocaine Change In Pain")
```

# 2019, 2020, 2021 - 
# pain score












```{r}
lido_change_in_pain2 <- abs(cleaned_data$intl_pain_lvl - cleaned_data$lido_20min)
 mean(lido_change_in_pain2, na.rm = TRUE)

#box.plot(cleaned_data$sal_change_in_pain)

ggplot(cleaned_data, aes(lido_change_in_pain2, fill = lido_eval_outcome)) +
  geom_boxplot() 

sal_change_in_pain2 <- abs(cleaned_data$intl_pain_lvl - cleaned_data$lido_20min)
 mean(sal_change_in_pain2, na.rm = TRUE)

#box.plot(cleaned_data$sal_change_in_pain)

ggplot(cleaned_data, aes(sal_change_in_pain, fill = sal_eval_outcome)) +
  geom_boxplot() 

```
## HEAD
- Which sites are often failing/passing? Look for outliers



```{r}
glimpse(cleaned_data_19_21)

```
       





- pain levels then site
- what does the data distribution look like?
<<<<<<< HEAD




- How does it look relative to previous years?

- How does it look relative to previous years? jumps


- Any more clues on the increase of injection rates?










```
```{r}
filter(new_cleaned_inj_data, visit_date >= "" )
```


```{r}

```

INCOMPLETE: Careful when running
```{r}

count()

# Usual area chart
time_series_plot <- cleaned_data %>%
  ggplot( aes(x = visit_dates, y = count(lido_eval_outcome)) +
    geom_area(fill = "#69b3a2", alpha = 0.5) +
    geom_line(color = "#69b3a2") +
    ylab("Lidocaine Evaluation Outcomes") +
    theme_ipsum()

# Turn it interactive with ggplotly
time_series_plot <- ggplotly(time_series_plot)
time_series_plot
```


